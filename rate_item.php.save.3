<?php
ini_set('display_errors',1);
error_reporting(E_ALL);
$host="localhost";
$username = "s2669198";
$password = "s2669198";
$database = "d2669198";

$conn = new mysqli($host,$username, $password, $database);

if ($conn->connect_error) {
    echo json_encode(["status" => "failed", "message" => "DB connection error"]);
    exit();
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (
        isset($_POST['user_id']) &&
        isset($_POST['item_id']) &&
        isset($_POST['rating'])
    ) {
        $userId = intval($_POST['user_id']);
        $itemId = intval($_POST['item_id']);
        $rating = floatval($_POST['rating']);

        $stmt = $conn->prepare("INSERT INTO ratings (user_id, item_id, rating) VALUES (?, ?, ?) 
                                ON DUPLICATE KEY UPDATE rating = VALUES(rating)");
        $stmt->bind_param("iid", $userId, $itemId, $rating);

        if ($stmt->execute()) {

                   $avgSql = "
        UPDATE items 
    SET rating = (
        SELECT ROUND(AVG(rating), 1) FROM ratings WHERE item_id = ?
    ),
    rating_count = (
        SELECT COUNT(*) FROM ratings WHERE item_id = ?
    )
    WHERE item_id = ?
";

$avgStmt = $conn->prepare($avgSql);
$avgStmt->bind_param("iii", $itemId, $itemId, $itemId);
$avgStmt->execute();
$avgStmt->close();            
echo json_encode(["status" => "success"]);
        } else {
            echo json_encode(["status" => "failed", "message" => "Database error"]);
        }

        $stmt->close();
    } else {
        echo json_encode(["status" => "failed", "message" => "Missing POST data"]);
    }
} else {
    echo json_encode(["status" => "failed", "message" => "Invalid request method"]);
}

$conn->close();
?>
